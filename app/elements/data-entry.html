<dom-module id="data-entry">
<style type="text/css">

	.col{
		margin-right: 30px;
	}
	.image-wrapper{
		overflow: hidden;
		border:1px solid #CCC;
	}
	#form-scanned{
		margin: -50px -100px 0 -100px ;
		width: 130%;
	}
	#form paper-input::shadow input{
		font-family: 'noto_sans_myanmarregular';
	}
	.input-select{
		position: relative;
	}
	.input-select paper-menu{
		padding: 0;
	}
	.input-select iron-collapse{
		position: absolute;
		left: 0;
		right: 0;
		z-index: 10;
	}
	#form-container{
		padding: 20px;
	}
	#submit-info{
		bottom:72px;
	}
</style>
<template>
	<iron-a11y-keys
      id="enter-key-submit"
      keys="enter"
      target="[[target]]"
      on-keys-pressed="submitForm">
    </iron-a11y-keys>

	<iron-ajax
    auto
    url="../form.json"
    handle-as="json",
    last-response="{{formfields}}">

    <iron-ajax
    	id="get-form"
	    url="/get-form"
	    handle-as="json"
	    on-response="_handleForm">
	<iron-ajax
    	id="get-source"
	    handle-as="json"
	    on-response="_generateDatalist">
	<div id="form-container" class="horizontal layout">
		<div class="col flex-7">
		<div class="image-wrapper">
			<img id="form-scanned" src="{{form_scanned}}"/>
		</div>
		</div>
		<div class="flex-5 col">
		<paper-toast id="submit-info" text="Data submitted, trying to get new form..."></paper-toast>
		<paper-toast id="form-info" text=""></paper-toast>
			<form is="iron-form" id="form" method="post" action="/submit-form" on-iron-form-response="_handleSubmit">
				<input type="hidden" name="form_id" value="{{form_id}}">
				<template is="dom-repeat" items="[[formfields]]" as="item">

						<template is="dom-if" if="{{_isTypeOf('string',item.type)}}">
							<div class="input input-text">
						       <paper-input id="{{_generateID('input_',item_field)}}" name="[[item.field]]" label="[[item.label]]" on-focus="_focusHandler" required="true"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('number',item.type)}}">
							<div class="input input-number">
						       <paper-input id="{{_generateID('input_',item_field)}}" type="number" name="[[item.field]]" label="[[item.label]]" on-focus="_focusHandler" required="true"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('date',item.type)}}">
							<div class="input input-date">
						       <paper-input id="{{_generateID('input_',item_field)}}" name="[[item.field]]" type="date" always-float-label label="[[item.label]]" on-focus="_focusHandler" required="true" min="[[item.min]]" max="[[item.max]]"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('autocomplete',item.type)}}">
							<div class="input input-autocomplete">
						       <paper-input id="{{_generateID('input_',item_field)}}" name="[[item.field]]" type="text" label="[[item.label]]" on-focus="_focusHandler" required="true" list$="{{_generateID('list_',item.field)}}"></paper-input>
						       <datalist id$="{{_generateID('list_',item.field)}}" data-source$="[[item.source]]">
						       		<template is="dom-repeat" items="[[item.options]]" as="option">
						       			<option>[[option]]</option>
						       		</template>						   
						       </datalist>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('string-options',item.type)}}">
							<div class="input input-dynamic">
										<span class="label">[[item.label]]</span>
						       			<paper-input id="{{_generateID('input_',item_field)}}" name="[[item.field]]" label="[[item.label]]" on-focus="_focusHandler" required="true"></paper-input>
	
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('select',item.type)}}">
					    	<div class="input input-select">
					    		<span class="label">[[item.label]]</span>
					    		<paper-radio-group  id="{{_generateID('input_',item_field)}}" attr-for-selected="value" on-change="_reRenderDynamicInput">
					    			<template is="dom-repeat" items="[[item.options]]" as="option">
					    				<paper-radio-button name="[[item.field]]" value="[[option.value]]" data-label$="[[option.label]]">[[option.value]]</paper-radio-button>
					    			</template>
								</paper-radio-group>
							</div>
					    </template>

				    </div>
				</template>
				<div class="submit">
					<paper-button raised on-click="submitForm">Submit Form</paper-button>
				</div>
			</form>

		</div>
	</div>
</template>
</dom-module>
<script>
(function() {
	Polymer({
      is: 'data-entry',
      properties:{
      	form_id:Number,
      	form_scanned:{
      		type:String,
      		value:'../images/blank-form.png'
      	},
      	target: {
	        type: Object,
	        value: function() {
	          return this.$$('#form');
	        }
	      }
      },
   	  _generateID:function(prefix,field){
   	  		return prefix+field;
   	  },
      _isTypeOf:function(type,val){
      		if(type===val){
      			return true;
      		}
      		else
      			return false;
      },
      ready:function(){
      	this.loadForm();
      },
      
      loadForm:function(){
      		this.$$('#get-form').generateRequest();
      },
      submitForm:function(){
      		this.$$('#form').submit();
      },
      _handleSubmit:function(ev){
      		console.log(ev);
      		if(ev.detail.status==='ok'){
				Polymer.dom(this.root).querySelectorAll('paper-input').forEach(function(el){
					el.value='';
				});
				Polymer.dom(this.root).querySelectorAll('paper-radio-button').forEach(function(el){
					el.checked=false;
				});
				this.$$('#submit-info').show();
      			this.$$('#get-form').generateRequest();
      		}
      },
      _handleForm:function(ev){
      		if(typeof ev.detail.response.form !=='undefined'){
      			this.form_scanned=ev.detail.response.form.scan_file;
      			this.form_id=ev.detail.response.form.id;
		  	}
		  	else if(ev.detail.response.status==='error'){
		  		page.redirect('/applogin');
		  	}
		  	else if(ev.detail.response.status==='done'){
		  		var forminfo=this.$$('#form-info');
		  		forminfo.text="No image to entry!";
		  		forminfo.show();
		  	}
      },
      _focusHandler:function(el){
      		var parent=Polymer.dom(el.srcElement).parentNode;

      		var autocomplete=parent.querySelector('datalist');
      		if(autocomplete!==null){
      			var options=autocomplete.querySelectorAll('option');
      			if(options.length===0){
      				var ajax = /** @type {!IronRequestElement} */ (document.createElement('iron-request'));
      				var params={
					        url: autocomplete.dataset['source'],
					        method: 'get',
					        handleAs:'json'
					      }
	      			ajax.completes.then(function(req){
	      				var template=autocomplete.querySelector('template');
	      				template.items=req.response;
	      			});

				    ajax.send(params);
      			}
      		}

      },

      _reRenderDynamicInput:function(ev){	
      		Polymer.dom(this.root).querySelector('.input-dynamic paper-input').label=ev.srcElement.dataset['label'];
      }
  	});
})();
</script>
