<dom-module id="data-entry">
<style type="text/css">

	.col{
		margin-right: 30px;
	}
	.image-wrapper{
		overflow: hidden;
		border:1px solid #CCC;
	}
	#form-scanned{
		margin: -50px -100px 0 -100px ;
		width: 130%;
	}
	#form paper-input::shadow input{
		font-family: 'noto_sans_myanmarregular';
	}
	.input-select{
		position: relative;
	}
	.input-select paper-menu{
		padding: 0;
	}
	.input-select iron-collapse{
		position: absolute;
		left: 0;
		right: 0;
		z-index: 10;
	}
	#form-container{
		padding: 20px;
	}
</style>
<template>
	<iron-a11y-keys
      id="enter-key-submit"
      keys="enter"
      target="[[target]]"
      on-keys-pressed="submitForm">
    </iron-a11y-keys>

	<iron-ajax
    auto
    url="../form.json"
    handle-as="json"
    last-response="{{formfields}}">

    <iron-ajax
    	id="get-form"
	    url="/get-form"
	    handle-as="json"
	    on-response="_handleForm">
	<iron-ajax
    	id="get-source"
	    handle-as="json"
	    on-response="_generateDatalist">
	<div id="form-container" class="horizontal layout">
		<div class="col flex-7">
		<div class="image-wrapper">
			<img id="form-scanned" src="{{form_scanned}}"/>
		</div>
		</div>
		<div class="flex-5 col">Form
		<paper-toast id="form-info" text=""></paper-toast>
			<form is="iron-form" id="form" method="post" action="/form/handler">
				<input type="hidden" name="form_id" value="{{form_id}}">
				<template is="dom-repeat" items="[[formfields]]" as="item">

						<template is="dom-if" if="{{_isTypeOf('string',item.type)}}">
							<div class="input input-text">
						       <paper-input name="[[item.field]]" label="[[item.label]]" on-focus="_focusHandler" required="true"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('number',item.type)}}">
							<div class="input input-number">
						       <paper-input type="number" name="[[item.field]]" label="[[item.label]]" on-focus="_focusHandler" required="true"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('date',item.type)}}">
							<div class="input input-date">
						       <paper-input name="[[item.field]]" type="date" always-float-label label="[[item.label]]" on-focus="_focusHandler" required="true" min="[[item.min]]" max="[[item.max]]"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('autocomplete',item.type)}}">
							<div class="input input-autocomplete">
						       <paper-input name="[[item.field]]" type="text" label="[[item.label]]" on-focus="_focusHandler" required="true" list$="{{_generateID(item.field)}}"></paper-input>
						       <datalist id$="{{_generateID(item.field)}}" data-source$="[[item.source]]">
						       		<template is="dom-repeat" items="[[item.options]]" as="option">
						       			<option>[[option]]</option>
						       		</template>						   
						       </datalist>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('string-options',item.type)}}">
					    	<span>[[item.label]]</span>
							<div class="input input-text">
						       <paper-input name="[[item.field]]" label="[[item.short_label]]" on-focus="_focusHandler" required="true"></paper-input>
					      	</div>
					    </template>

					    <template is="dom-if" if="{{_isTypeOf('select',item.type)}}">
					    	<div class="input input-select">
					    		<paper-input name="[[item.field]]" label="[[item.label]]" on-focus="_focusHandler" on-enter-key="_selectItem"></paper-input>
					    		<iron-collapse>
						    		<paper-material class="options" elevation="1">
									    <paper-menu>
										  	<template is="dom-repeat" items="[[item.options]]" as="option">
										  		<paper-item>[[option]]</paper-item>
										  	</template>
										</paper-menu>
									</paper-material>
								</iron-collapse>
							</div>
					    </template>

				    </div>
				</template>
				<div class="submit">
					<paper-button raised on-click="submitForm">Submit Form</paper-button>
				</div>
			</form>

		</div>
	</div>
</template>
</dom-module>
<script>
(function() {
	Polymer({
      is: 'data-entry',
      properties:{
      	form_id:Number,
      	form_scanned:{
      		type:String,
      		value:'../images/mps-logo-no-text.png'
      	},
      	target: {
	        type: Object,
	        value: function() {
	          return this.$$('#form');
	        }
	      }
      },
   	  _generateID:function(field){
   	  		return 'list_'+field;
   	  },
      _isTypeOf:function(type,val){
      		if(type===val){
      			return true;
      		}
      		else
      			return false;
      },
      ready:function(){
      	this.loadForm();
      },
      
      loadForm:function(){
      		this.$$('#get-form').generateRequest();
      },
      submitForm:function(){
      		this.$$('#form').submit();
      },
      _handleForm:function(ev){
      		if(typeof ev.detail.response.form !=='undefined'){
      			this.form_scanned=ev.detail.response.form.scan_file;
      			this.form_id=ev.detail.response.form.id;
		  	}
		  	else if(ev.detail.response.status==='error'){
		  		page.redirect('/applogin');
		  	}
		  	else if(ev.detail.response.status==='done'){
		  		var forminfo=this.$$('#form-info');
		  		forminfo.text="All image already process please try again later!";
		  		forminfo.show();
		  	}
      },
      _focusHandler:function(el){
      		var parent=Polymer.dom(el.srcElement).parentNode;
      		
      		Polymer.dom(this.root).querySelectorAll('iron-collapse').forEach(function(optionEl){
      			if(optionEl.opened){
      				var parentOption=Polymer.dom(optionEl).parentNode;
	      			var menu=parentOption.querySelector('paper-menu');

	      			if(typeof menu.selectedItems!=='undefined'){
	      				var input=parentOption.querySelector('paper-input');
	      				input.value=menu.selectedItems[0].textContent;
	      			}
	      			optionEl.toggle();
      			}
      		});
      		var select=parent.querySelector('iron-collapse');
      		if(select!==null){
      			console.log(select);
      			select.toggle();
      			console.log(parent.querySelector('paper-menu').focusedItem);
      			parent.querySelector('paper-menu').select(0);

      		}

      		var autocomplete=parent.querySelector('datalist');
      		if(autocomplete!==null){
      			var options=autocomplete.querySelectorAll('option');
      			if(options.length===0){
      				var ajax = /** @type {!IronRequestElement} */ (document.createElement('iron-request'));
      				var params={
					        url: autocomplete.dataset['source'],
					        method: 'get',
					        handleAs:'json'
					      }
	      			ajax.completes.then(function(req){
	      				var template=autocomplete.querySelector('template');
	      				template.items=req.response;
	      				console.log(req.response);
	      			});

				    ajax.send(params);
      			}
      		}

      },
   
      _selectItem:function(ev){

      },
      _hideDropdown:function(el){
      		var parent=Polymer.dom(el.srcElement).parentNode;
      		parent.querySelector('paper-material').style.display='hidden';
      }
  	});
})();
</script>
